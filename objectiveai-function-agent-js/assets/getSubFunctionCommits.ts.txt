import { execSync } from "child_process";
import { existsSync, readdirSync, readFileSync, statSync } from "fs";

// Read JSON file that should contain a string value
// Handles both quoted ("value") and unquoted (value) content
function readStringJsonFile(path: string): string | null {
  if (!existsSync(path)) {
    return null;
  }
  let content = readFileSync(path, "utf-8").trim();
  if (!content || content === "null") {
    return null;
  }
  // Remove surrounding quotes if both present (only one pair)
  if (content.startsWith('"') && content.endsWith('"')) {
    content = content.slice(1, -1);
  }
  return content;
}

interface SubFunctionInfo {
  name: string;
  owner: string;
  repository: string;
  commit: string;
  path: string;
}

function main(): void {
  const agentFunctionsDir = "agent_functions";

  if (!existsSync(agentFunctionsDir)) {
    console.log("No agent_functions directory found.");
    console.log("\n=== SUB_FUNCTION_COMMITS ===");
    console.log("[]");
    return;
  }

  const entries = readdirSync(agentFunctionsDir);
  const results: SubFunctionInfo[] = [];

  for (const entry of entries) {
    const subFunctionPath = `${agentFunctionsDir}/${entry}`;

    // Skip non-directories and hidden files
    if (!statSync(subFunctionPath).isDirectory() || entry.startsWith(".")) continue;

    // Get the commit SHA from git
    let commit: string;
    try {
      commit = execSync("git rev-parse HEAD", {
        cwd: subFunctionPath,
        encoding: "utf-8",
        stdio: "pipe",
      }).trim();
    } catch {
      console.log(`Failed to get commit for ${subFunctionPath}`);
      continue;
    }

    // Get owner/repository from github/name.json if it exists
    let owner = "";
    let repository = "";
    const namePath = `${subFunctionPath}/github/name.json`;
    const name = readStringJsonFile(namePath);
    if (name) {
      const parts = name.split("/");
      if (parts.length === 2) {
        owner = parts[0];
        repository = parts[1];
      }
    }

    results.push({
      name: entry,
      owner,
      repository,
      commit,
      path: subFunctionPath,
    });
  }

  // Sort by name
  results.sort((a, b) => a.name.localeCompare(b.name));

  console.log("\n=== SUB_FUNCTION_COMMITS ===");
  console.log(JSON.stringify(results, null, 2));
}

main();
