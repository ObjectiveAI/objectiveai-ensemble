# Builder
FROM node:20 AS builder
ARG AUTH_GOOGLE_CLIENT_ID
ENV AUTH_GOOGLE_CLIENT_ID=${AUTH_GOOGLE_CLIENT_ID}
ARG AUTH_GOOGLE_CLIENT_SECRET
ENV AUTH_GOOGLE_CLIENT_SECRET=${AUTH_GOOGLE_CLIENT_SECRET}
ARG AUTH_GITHUB_CLIENT_ID
ENV AUTH_GITHUB_CLIENT_ID=${AUTH_GITHUB_CLIENT_ID}
ARG AUTH_GITHUB_CLIENT_SECRET
ENV AUTH_GITHUB_CLIENT_SECRET=${AUTH_GITHUB_CLIENT_SECRET}
ARG AUTH_TWITTER_CLIENT_ID
ENV AUTH_TWITTER_CLIENT_ID=${AUTH_TWITTER_CLIENT_ID}
ARG AUTH_TWITTER_CLIENT_SECRET
ENV AUTH_TWITTER_CLIENT_SECRET=${AUTH_TWITTER_CLIENT_SECRET}
ARG AUTH_REDDIT_CLIENT_ID
ENV AUTH_REDDIT_CLIENT_ID=${AUTH_REDDIT_CLIENT_ID}
ARG AUTH_REDDIT_CLIENT_SECRET
ENV AUTH_REDDIT_CLIENT_SECRET=${AUTH_REDDIT_CLIENT_SECRET}
ARG NEXTAUTH_URL
ENV NEXTAUTH_URL=${NEXTAUTH_URL}
ARG NEXTAUTH_SECRET
ENV NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
ARG NEXT_PUBLIC_API_URL
ENV NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
ARG NODE_ENV
ENV NODE_ENV=${NODE_ENV}
ARG NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
ENV NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
ARG IP_RSA_PUBLIC_KEY
ENV IP_RSA_PUBLIC_KEY=${IP_RSA_PUBLIC_KEY}
ARG USER_IP_HEADER
ENV USER_IP_HEADER=${USER_IP_HEADER}
ARG NEXT_PUBLIC_SONARLY_PROJECT_KEY
ENV NEXT_PUBLIC_SONARLY_PROJECT_KEY=${NEXT_PUBLIC_SONARLY_PROJECT_KEY}
ARG NEXT_PUBLIC_SONARLY_INGEST_POINT
ENV NEXT_PUBLIC_SONARLY_INGEST_POINT=${NEXT_PUBLIC_SONARLY_INGEST_POINT}
# Install workspace
WORKDIR /root
COPY package.json package-lock.json ./
COPY objectiveai-js/ objectiveai-js/
COPY objectiveai-web-new/package.json objectiveai-web-new/
RUN npm install --include=dev
# Build workspace
COPY objectiveai-web-new/ objectiveai-web-new/
RUN npm run build --workspace=objectiveai-web-new
# Remove symlinks
WORKDIR /root/objectiveai-web-new
RUN rm -rf node_modules/objectiveai \
  && mkdir -p node_modules/objectiveai \
  && cp -R /root/objectiveai-js/dist/* node_modules/objectiveai/ \
  && cp /root/objectiveai-js/package.json node_modules/objectiveai/package.json

# Runner
FROM node:20-slim AS runner
ARG AUTH_GOOGLE_CLIENT_ID
ENV AUTH_GOOGLE_CLIENT_ID=${AUTH_GOOGLE_CLIENT_ID}
ARG AUTH_GOOGLE_CLIENT_SECRET
ENV AUTH_GOOGLE_CLIENT_SECRET=${AUTH_GOOGLE_CLIENT_SECRET}
ARG AUTH_GITHUB_CLIENT_ID
ENV AUTH_GITHUB_CLIENT_ID=${AUTH_GITHUB_CLIENT_ID}
ARG AUTH_GITHUB_CLIENT_SECRET
ENV AUTH_GITHUB_CLIENT_SECRET=${AUTH_GITHUB_CLIENT_SECRET}
ARG AUTH_TWITTER_CLIENT_ID
ENV AUTH_TWITTER_CLIENT_ID=${AUTH_TWITTER_CLIENT_ID}
ARG AUTH_TWITTER_CLIENT_SECRET
ENV AUTH_TWITTER_CLIENT_SECRET=${AUTH_TWITTER_CLIENT_SECRET}
ARG AUTH_REDDIT_CLIENT_ID
ENV AUTH_REDDIT_CLIENT_ID=${AUTH_REDDIT_CLIENT_ID}
ARG AUTH_REDDIT_CLIENT_SECRET
ENV AUTH_REDDIT_CLIENT_SECRET=${AUTH_REDDIT_CLIENT_SECRET}
ARG NEXTAUTH_URL
ENV NEXTAUTH_URL=${NEXTAUTH_URL}
ARG NEXTAUTH_SECRET
ENV NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
ARG NEXT_PUBLIC_API_URL
ENV NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
ARG NODE_ENV
ENV NODE_ENV=${NODE_ENV}
ARG NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
ENV NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
ARG IP_RSA_PUBLIC_KEY
ENV IP_RSA_PUBLIC_KEY=${IP_RSA_PUBLIC_KEY}
ARG USER_IP_HEADER
ENV USER_IP_HEADER=${USER_IP_HEADER}
ARG NEXT_PUBLIC_SONARLY_PROJECT_KEY
ENV NEXT_PUBLIC_SONARLY_PROJECT_KEY=${NEXT_PUBLIC_SONARLY_PROJECT_KEY}
ARG NEXT_PUBLIC_SONARLY_INGEST_POINT
ENV NEXT_PUBLIC_SONARLY_INGEST_POINT=${NEXT_PUBLIC_SONARLY_INGEST_POINT}
WORKDIR /root
COPY --from=builder /root/objectiveai-web-new/.next .next
COPY --from=builder /root/objectiveai-web-new/public public
COPY --from=builder /root/objectiveai-web-new/node_modules node_modules
COPY --from=builder \
    /root/objectiveai-web-new/package.json \
    /root/objectiveai-web-new/next.config.ts \
    ./
CMD ["npx", "next", "start"]
